# Server guide

This guide assumes you have a user on the drumstrokes server. It should be enough to download the test responses, upload a new xml test file, etc. If you ever need to edit file/folder permissions on the server, you will have to ask the IT department to add you to the sudo list.

## Setup ssh connection to the server

Open a terminal and go to your hidden ssh folder:

    cd ~/.ssh

Inside the directory, edit or create a file called `config`, e.g. (if the file is not there)

    vi config

and add the following content:

    Host aau_gateway
        HostName sshgw.aau.dk
        User <AAU FULL EMAIL>
        ServerAliveInterval 30
        ServerAliveCountMax 2

    Host drumstrokes
        HostName 130.225.57.125
        User <AAU FULL EMAIL>
        IdentityFile ~/.ssh/id_rsa
        ProxyCommand ssh aau_gateway nc %h %p
        ServerAliveInterval 30
        ServerAliveCountMax 2

This sets up ssh aliases for the AAU gateway and the server, so that you can access the server through the gateway using a proxy command (compare with the instructions from the IT department: they ask you to ssh the gateway and then ssh the server from the gateway).

Be sure to replace the fields `<AAU FULL EMAIL>` with your own account.

## Connect to the server

Now, open a new terminal and type

    ssh drumstrokes

After running the command, you will be prompted to type in your AAU password. Afterwards, you will have to confirm your login attempt using the Microsoft Authenticator app, by clicking "Approve" on the app notification. You can set it up by following [these instructions](https://www.en.its.aau.dk/instructions/Username+and+password/Azure+MFA/). Once you authorize using the app, another password prompt will appear, asking you for the server password (the IT department should have assigned you your AAU password as server password).

If you also want to avoid using the 2-factor authentication through the Microsoft Authenticator app, you should access the server through the [AAU VPN](https://www.en.its.aau.dk/instructions/VPN/).

## Look for ssh keys

Type the following on a terminal:

    ls -al ~/.ssh

The command will list the content of your `.ssh` directory; if you see a file called `id_rsa.pub`, it means you already created an SSH key and you can skip the next step.

## Create SSH key

On your local machine, type the following on a terminal:

    ssh-keygen -t rsa -b 4096 -C "<AAU FULL EMAIL>"

Make sure to replace `<AAU FULL EMAIL>` with your AAU email address. In the following prompts, you can just keep the default settings, although you might want to set up a passphrase if e.g. you are sharing your computer.

Once you have an SSH key pair, you must upload the public one to the workstation. From a terminal, type:

    ssh-copy-id drumstrokes

Follow the directions of the prompts, and verify that the procedure was successful by typing:

    ssh drumstrokes

If everything worked, you will only have to type your AAU email password (if you have left your passphrase empty). Remember that you need to set up AAU's 2-factor validation and have your mobile phone at hand, and make sure you write your AAU email password down (or that you are able to paste it in a terminal window) if is complicated (e.g. autogenerated).

## Server structure

Once you ssh the server, you will access it from your own home folder. The listening test lives in the following folder:

    cd /srv/web/drumstrokelisteningtest.aau.dk/https/

This is where the URL `https://drumstrokelisteningtest.aau.dk/` points at. thus we can access the test by opening

    https://drumstrokelisteningtest.aau.dk/test.html?url=tests/drumStrokes.xml

from a browser.

## Uploading a new xml test file to the server

There are several ways. Using `scp` is probably the most straightforward. Open a terminal, cd to your local repo folder, access the `tests` subfolder (e.g. `../ASIAMS/listeningTest/tests/`) and run the following: 

    scp drumStrokes.xml drumstrokes:/srv/web/drumstrokelisteningtest.aau.dk/https/tests/

Check the `scp` help for more information about syntax, flags, etc.

## Downloading the xml answer files to your local machine

You could run some of the analysis scripts directly on the server, since it has Python installed. However, some of the scripts have dependencies, e.g. `matplotlib`. The easiest solution seems to copy the xml answer files to your local machine. From a **local** terminal, cd the `saves` subdirectory (e.g. `../ASIAMS/listeningTest/saves/`) and run the following:

    scp drumstrokes:/srv/web/drumstrokelisteningtest.aau.dk/https/saves/*.xml .

This copies all the xml files in the `saves` subdirectory on the server to your local copy. Since the subject id's are unique, I expect that you can populate your local `saves` subdirectory gradually as the server gets populated with answers (but you should store the pilot test xml answers somewhere else before running the analysis scripts).

## Running the analyis script

After completing the previous steps, cd to your local `python` subdirectory and run any relevant script, e.g.

    python score_parser.py
    python survey_parser.py

These are the most useful ones. Please refer to the complete guide on the [WebAudioEvaluationTool wiki](https://github.com/BrechtDeMan/WebAudioEvaluationTool/wiki/Analysis-and-diagnostics).

Some of the scripts require Python dependencies. One very practical solution is running them from a conda environment with the right packages installed.

The aforementioned scripts create a `ratings/` folder inside `saves/` by default, with csv files split by test page and survey element respectively. Despite the slightly buggy interface, I am assuming that the test is configured correctly, so any warning about incomplete responses would refer to subjects that have abandoned the test before the end.

If you want to get everything in a single csv, then it's either copy/paste in a spreadsheet generated from the csv, or in a text editor (the subject id order is retained), or, more practically, a script (Matlab, Python, or whatever you like) that merges the single csv's into a big one or does more sophisticated things if needed.
